
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />


    <link rel="stylesheet" type="text/css" href="https://oxdef.info/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://oxdef.info/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://oxdef.info/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://oxdef.info//static/custom.css" rel="stylesheet">


    <link href="https://oxdef.info/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="oxdef RSS">

    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">



<meta name="author" content="oxdef" />
<meta name="description" content="There is a powerful feature of Content Security Policy called Reporting. Web application owner can specify special URI via report-uri directive to which the user agent will send reports about policy violation. In testing environment it helps to find missed resource inclusions so with enforced policy your web application will …" />
<meta name="keywords" content="csp, nginx">

<meta property="og:site_name" content="oxdef"/>
<meta property="og:title" content="CSP violation report aggregation using Nginx only"/>
<meta property="og:description" content="There is a powerful feature of Content Security Policy called Reporting. Web application owner can specify special URI via report-uri directive to which the user agent will send reports about policy violation. In testing environment it helps to find missed resource inclusions so with enforced policy your web application will …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://oxdef.info/posts/csp-report-aggregation-using-only-nginx"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-04-24 16:29:00+03:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://oxdef.info/author/oxdef.html">
<meta property="article:section" content="misc"/>
<meta property="article:tag" content="csp"/>
<meta property="article:tag" content="nginx"/>
<meta property="og:image" content="/images/dots.png">

  <title>oxdef &ndash; CSP violation report aggregation using Nginx only</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://oxdef.info">
        <img src="/images/dots.png" alt="oxdef" title="oxdef">
      </a>
      <h1><a href="https://oxdef.info">oxdef</a></h1>

<p>Some thoughts on web security</p>
      <nav>
        <ul class="list">
          <li><a href="https://oxdef.info/about">About</a></li>
          <li><a href="https://oxdef.info/csp-reporter">CSP Reporter</a></li>
          <li><a href="https://oxdef.info/csp-tester">CSP Tester</a></li>

          <li><a href="https://www.owasp.org/index.php/Russia" target="_blank">OWASP Russia</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:oxdef@oxdef.info" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-github" href="https://github.com/oxdef" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/oxdef" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="/feeds/all.rss.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="csp-report-aggregation-using-only-nginx">CSP violation report aggregation using Nginx only</h1>
    <p>
          Posted on 24 April 2016 in <a href="https://oxdef.info/category/misc">misc</a>


    </p>
  </header>


  <div>
    <p>There is a powerful feature of <a href="https://www.w3.org/TR/CSP/">Content Security Policy</a> called <a href="https://www.w3.org/TR/CSP/#violation-reports">Reporting</a>. Web application owner can specify special URI via <code>report-uri</code> directive to which the user agent will send reports about policy violation. In testing environment it helps to find missed resource inclusions so with enforced policy your web application will not work correctly. In production environment it helps to detect that someone or something trying to attack your site users with XSS attack or inject unwanted 3rd party JavaScript code. So it is a good practice to always include <code>report-uri</code> in CSP policy of your web application.</p>
<p>The violation reports are in JSON format and delivered by HTTP POST requests. Let's try to make CSP violation report aggregation using Nginx only. </p>
<p>For the first we need to initialize separate log format for logging POST request body. We also making auxiliary <code>map</code> because we will accept only requests with a <code>Content-Type</code> header field of <code>application/csp-report</code> or <code>application/json</code>.</p>
<div class="highlight"><pre><span></span><span class="k">http</span> <span class="p">{</span>
<span class="kn">...</span>
    <span class="s">log_format</span>  <span class="s">csp_report</span> <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#39;</span>
        <span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span> <span class="s">&quot;</span><span class="nv">$content_type&quot;</span> <span class="s">&quot;</span><span class="nv">$http_user_agent&quot;</span> <span class="s">&quot;</span><span class="nv">$request_body&quot;&#39;</span><span class="p">;</span>

    <span class="kn">map</span> <span class="nv">$status</span> <span class="nv">$csp_loggable</span> <span class="p">{</span>
        <span class="kn">&quot;200&quot;</span>  <span class="mi">1</span><span class="p">;</span>
        <span class="kn">default</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">map</span> <span class="nv">$content_type</span> <span class="nv">$csp_bad_content_type</span> <span class="p">{</span>
        <span class="kn">default</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kn">&quot;application/json&quot;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kn">&quot;application/csp-report&quot;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="kn">...</span>
<span class="err">}</span>
</pre></div>


<p>To log POST request body we use variable <code>$request_body</code>. According to <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_body">Nginx documentation</a>:</p>
<blockquote>
<p>The variable’s value is made available in locations processed by the proxy_pass, fastcgi_pass, uwsgi_pass, and scgi_pass directives. </p>
</blockquote>
<p>So we need to make "fake" location and use it in <code>proxy_pass</code> directive.</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
<span class="kn">...</span>
    <span class="s">location</span> <span class="s">/fakeloc</span> <span class="p">{</span>
        <span class="kn">return</span> <span class="mi">200</span><span class="p">;</span>    
    <span class="p">}</span>
<span class="kn">...</span>
<span class="err">}</span>
</pre></div>


<p>The main part of our Nginx based reporting is <code>location /cspreport</code>:</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
<span class="kn">...</span>
  <span class="s">location</span> <span class="s">/cspreport</span> <span class="p">{</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="s">!=</span> <span class="s">&quot;POST&quot;)</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">405</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">if</span> <span class="s">(</span><span class="nv">$csp_bad_content_type</span><span class="s">)</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">415</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">access_log</span>  <span class="s">/var/log/nginx/csp.log</span> <span class="s">csp_report</span> <span class="s">if=</span><span class="nv">$csp_loggable</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://SERVER_IP:80/fakeloc</span><span class="p">;</span>
    <span class="p">}</span>
<span class="kn">...</span>
<span class="err">}</span>
</pre></div>


<p>The advantages of this solution are:</p>
<ul>
<li>There is no need in separate script for report aggregation</li>
<li>Built-in log rotation</li>
</ul>
<p>Сons are:</p>
<ul>
<li>Nignx config language is not so powerful as e.g. Python</li>
</ul>
<p>For analysis of such logs can be used <a href="https://oxdef.info/csp-reporter/">CSP Reporter</a>.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://oxdef.info/tag/csp">csp</a>
      <a href="https://oxdef.info/tag/nginx">nginx</a>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy;  2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " oxdef ",
  "url" : "https://oxdef.info",
  "image": "/images/dots.png",
  "description": ""
}
</script>

</body>
</html>